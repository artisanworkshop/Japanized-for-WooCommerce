"use strict";(self.webpackChunkpeachpay_for_woocommerce=self.webpackChunkpeachpay_for_woocommerce||[]).push([[976],{8756:(a,e,n)=>{n.r(e),n.d(e,{default:()=>C});var t=n(655),o=n(2121),r=n(7059),c=n(7629),s=n(7462),i=n(9350),u=n(6673),d=n(9545);function l(){r.h.subscribe((function(){var a,e,n,t,o,r,i,l,p,m,h;a=c.hv.selectedProvider(),e=s.qA.modalUI.loadingMode(),n=u.z9.total(),t=u.z9.subscriptionPresent(),null===(o=(0,d.MW)('.pp-pm-type[data-method="amazon-pay"]'))||void 0===o||o.classList.remove("hide"),"amazonpay"===a&&"finished"===e&&!t&&n>0?(null===(r=(0,d.MW)("#amazon-pay-btn-container"))||void 0===r||r.classList.remove("hide"),null===(i=(0,d.MW)("#amazon-pay-btn-container-existing"))||void 0===i||i.classList.remove("hide"),null===(l=(0,d.MW)("#amazon-pay-btn-container-mobile"))||void 0===l||l.classList.remove("hide")):(null===(p=(0,d.MW)("#amazon-pay-btn-container"))||void 0===p||p.classList.add("hide"),null===(m=(0,d.MW)("#amazon-pay-btn-container-existing"))||void 0===m||m.classList.add("hide"),null===(h=(0,d.MW)("#amazon-pay-btn-container-mobile"))||void 0===h||h.classList.add("hide"))}))}var p=n(3413),m=n(9970),h=n(7418),y=n(6204),v=n(8401);function b(){var a=m.gx.shipping,e=a.firstName,n=a.lastName,o=a.address1,r=a.address2,c=a.city,s=a.state,i=a.postal,u=a.country,d=a.phone,l=0===r().length?{}:{addressLine1:r()};return(0,t.pi)({name:e()+" "+n(),addressLine1:o(),city:c(),stateOrRegion:s(),postalCode:i(),countryCode:u(),phoneNumber:d()},l)}function f(a){switch(a){case"US":return"https://static-na.payments-amazon.com/checkout.js";case"JP":return"https://static-fe.payments-amazon.com/checkout.js";case"GB":case"DK":case"FR":case"DE":case"HU":case"IT":case"LU":case"AW":case"PT":case"ES":case"SE":return"https://static-eu.payments-amazon.com/checkout.js";default:return}}function z(a,e){return(0,t.mG)(this,void 0,void 0,(function(){var n;return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return[4,fetch((0,p.BS)(i.l9.hostName(),s.qA.testMode())+"api/v1/amazonpay/signature",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session:{id:v.Z5.sessionId(),merchant_id:i.l9.id(),merchant_url:i.l9.hostName(),merchant_name:i.l9.name(),plugin_version:s.qA.plugin.version(),platform:"woocommerce"},transaction:{amazonpay:{payload:a,sandbox:e}}})})];case 1:return(n=t.sent()).ok?[4,n.json()]:[2,""];case 2:return[2,t.sent().signature]}}))}))}function g(a){var e,n,o;return(0,t.mG)(this,void 0,void 0,(function(){var r,c,d,l,p,m,h,y;return(0,t.Jh)(this,(function(v){switch(v.label){case 0:return r=null!==(e=s.L0.metadata("amazonpay_payment_method","public_key_id"))&&void 0!==e?e:"",c=null!==(n=s.L0.metadata("amazonpay_payment_method","store_id"))&&void 0!==n?n:"",d=null!==(o=s.L0.metadata("amazonpay_payment_method","merchant_id"))&&void 0!==o?o:"",l=s.qA.isTestOrDevSite(),p=i.l9.currency.configuration().number_of_decimals,m=u.z9.virtual()?{}:{addressDetails:b()},[4,z(h=(0,t.pi)({webCheckoutDetails:{checkoutResultReturnUrl:a,checkoutMode:"ProcessOrder"},storeId:c,scopes:["name","email","phoneNumber","billingAddress"],paymentDetails:{paymentIntent:"AuthorizeWithCapture",chargeAmount:{amount:u.AQ.total().toFixed(p),currencyCode:i.l9.currency.code()},presentmentCurrency:i.l9.currency.code()}},m),l)];case 1:return y=v.sent(),[2,{publicKeyId:r,storeId:c,merchantId:d,sandbox:l,addressDetails:m,payload:h,signature:y}]}}))}))}function _(a,e){var n,t,o=s.L0.metadata(a,"limits");if(!o)return"n/a";var r=o;if(!r)return"n/a";if(r.default_currency!==i.l9.currency.code())return"n/a";var c=null!==(n=r["pm_".concat(e)])&&void 0!==n?n:"n/a",u=null!==(t=r["merchant_".concat(e)])&&void 0!==t?t:"n/a";return"n/a"!==u?u:c}const L=n.p+"img/f3896d63aa9fcf4e95c0-amazon.svg",w=n.p+"img/2c43108c2527a9ce8f67-amazon-pay-card.svg";var A=n(3176),k=n(3305);function C(a){return(0,t.mG)(this,void 0,void 0,(function(){var e=this;return(0,t.Jh)(this,(function(n){switch(n.label){case 0:return[4,(0,d.ve)("https://static-na.payments-amazon.com/checkout.js","amazon",(function(){!function(){var a,e,n={},o=function(){var a,e,n;return{config:{name:"Amazon Pay",slug:"amazonpay",gateway:"peachpay_amazonpay",description:"Please click the Amazon Pay button to complete your checkout.",reusable:!1,assets:{title:{src:w},badge:{src:L}},defaultCurrency:s.L0.metadata("amazonpay_payment_method","default_currency"),currencies:null!==(a=s.L0.metadata("amazonpay_payment_method","supported_currencies"))&&void 0!==a?a:["ALL"],supports:{minimumTotal:_("amazonpay_payment_method","min"),maximumTotal:_("amazonpay_payment_method","max"),currencies:null!==(e=s.L0.metadata("amazonpay_payment_method","supported_currencies"))&&void 0!==e?e:["ALL"],customerCountries:null!==(n=s.L0.metadata("amazonpay_payment_method","supported_countries"))&&void 0!==n?n:["ALL"],productTypes:[],virtualProducts:!0,shippingMethods:[]}}}}();n.amazonpay=o;var i={methods:{}};try{for(var u=(0,t.XA)(Object.entries(n)),d=u.next();!d.done;d=u.next()){var l=(0,t.CR)(d.value,2),p=l[0],m=l[1];i.methods[p]=m.config}}catch(e){a={error:e}}finally{try{d&&!d.done&&(e=u.return)&&e.call(u)}finally{if(a)throw a.error}}r.h.dispatch((0,c.DK)({amazonpay:i}))}(),l();var n="",o=s.qA.modalUI.page();r.h.subscribe((function(){return(0,t.mG)(e,void 0,void 0,(function(){return(0,t.Jh)(this,(function(e){switch(e.label){case 0:return 0===u.AQ.total()?[2]:"amazonpay:amazonpay"===c.hv.selectedPaymentMethod()&&"amazonpay:amazonpay"!==n||"amazonpay:amazonpay"===c.hv.selectedPaymentMethod()&&"payment"===s.qA.modalUI.page()&&"payment"!==o?(n="amazonpay:amazonpay",o="payment",[4,I(a)]):[3,2];case 1:e.sent(),e.label=2;case 2:return c.hv.selectedPaymentMethod()!==n&&(n=c.hv.selectedPaymentMethod()),s.qA.modalUI.page()!==o&&(o=s.qA.modalUI.page()),[2]}}))}))}))}))];case 1:return n.sent(),[2]}}))}))}function I(a){var e,n,o;return(0,t.mG)(this,void 0,void 0,(function(){var r,c=this;return(0,t.Jh)(this,(function(s){switch(s.label){case 0:return(0,d.HD)(".pp-amazon-pay-btn-container",(function(a){var e=a.id,n=a.parentElement;null==n||n.replaceChildren(),null!==n&&(n.innerHTML="");var t='<div id="'.concat(e,'" class=""></div>');null==n||n.insertAdjacentHTML("beforeend",t)})),null===(e=(0,d.MW)("#amazon-pay-btn-container"))||void 0===e||e.classList.add("pp-amazon-pay-btn-container"),null===(n=(0,d.MW)("#amazon-pay-btn-container-mobile"))||void 0===n||n.classList.add("pp-amazon-pay-btn-container"),null===(o=(0,d.MW)("#amazon-pay-btn-container-existing"))||void 0===o||o.classList.add("pp-amazon-pay-btn-container"),[4,g("".concat(k.a.phpData.plugin_asset_url,"public/amazon-checkout.html"))];case 1:return r=s.sent(),["#amazon-pay-btn-container","#amazon-pay-btn-container-mobile","#amazon-pay-btn-container-existing"].forEach((function(e){amazon.Pay.renderButton(e,{merchantId:r.merchantId,publicKeyId:r.publicKeyId,ledgerCurrency:i.l9.currency.code(),checkoutLanguage:"en_US",productType:u.z9.virtual()?"PayOnly":"PayAndShip",placement:"Cart",buttonColor:"Gold",sandbox:r.sandbox}).onClick((function(){return(0,t.mG)(c,void 0,void 0,(function(){var e,n;return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return null===(n=(0,d.MW)("body"))||void 0===n||n.classList.add("pp-disabled"),e="".concat(k.a.phpData.plugin_asset_url,"public/amazon-checkout.html"),[4,M(r,e,a)];case 1:return t.sent(),[2]}}))}))}))})),[2]}}))}))}function M(a,e,n){return(0,t.mG)(this,void 0,void 0,(function(){var o,c,l,h,y,b,z=this;return(0,t.Jh)(this,(function(g){switch(g.label){case 0:return o=i.l9.currency.configuration().number_of_decimals,c=btoa(JSON.stringify({buttonData:{merchantId:a.merchantId,publicKeyId:a.publicKeyId,ledgerCurrency:i.l9.currency.code(),checkoutLanguage:s.qA.language().replace("-","_"),productType:u.z9.virtual()?"PayOnly":"PayAndShip",placement:"Cart",buttonColor:"Gold",sandbox:a.sandbox},initCheckoutData:{createCheckoutSessionConfig:{payloadJSON:JSON.stringify(a.payload),signature:a.signature,publicKeyId:a.publicKeyId}},scriptLink:f(m.gx.billing.country())})),l=function(a,e,n,t,o){if(null!==(null==n?void 0:n.top)){var r=n.top.outerHeight/2+n.top.screenY-o/2,c=n.top.outerWidth/2+n.top.screenX-t/2;return n.open(a,e,"toolbar=no, location=no, directories=no, status=yes, menubar=no, scrollbars=yes, resizable=yes, copyhistory=no, width=".concat(t,", height=").concat(o,", top=").concat(r,", left=").concat(c))}return null}("".concat(e,"?amazon_data=").concat(c),"amazonPayPopup",window,550,515),h=setInterval((function(){var a;(null==l?void 0:l.closed)&&(clearInterval(h),null===(a=(0,d.MW)("body"))||void 0===a||a.classList.remove("pp-disabled"))}),1e3),null===l?[3,3]:[4,n.startTransaction("peachpay_amazonpay","default")];case 1:return y=g.sent(),[4,n.placeOrder(y)];case 2:if(b=g.sent(),!y||"success"!==b.result)return[2];(0,d.JM)("pp-amazon-popup-closed",(function(){var a;null===(a=(0,d.MW)("body"))||void 0===a||a.classList.remove("pp-disabled")})),(0,d.ml)("pp-amazon-checkout-failed",(function(e){r.h.dispatch((0,s.tv)()),window.alert("Amazon Pay was unable to proceed with checkout due to the following:\n".concat(e.message)),(0,A.W4)(new Error(e.message),{amazonpay_session:a})})),(0,d.ml)("pp-amazon-checkout-complete",(function(e){return(0,t.mG)(z,void 0,void 0,(function(){var c,d,m,h;return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return c=e.sessionId,l.postMessage({event:"pp-amazon-received-session-id"},"*"),d={session:{id:v.Z5.sessionId(),merchant_id:i.l9.id(),merchant_url:i.l9.hostName(),merchant_name:i.l9.name(),plugin_version:s.qA.plugin.version(),platform:"woocommerce"},transaction:{amazonpay:{payload:{chargeAmount:{amount:u.AQ.total().toFixed(o),currencyCode:i.l9.currency.code()}},session_id:c,sandbox:a.sandbox}},order:{id:String(b.order_id),amount:u.AQ.total().toFixed(o),currency:i.l9.currency.code(),data:b}},[4,fetch((0,p.BS)(i.l9.hostName(),s.qA.testMode())+"api/v1/amazonpay/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})];case 1:return(m=t.sent()).ok?[4,m.json()]:((0,A.W4)(new Error("Call to PeachPay API /amazonpay/checkout failed"),{amazonpay_session:a,request:d,response:m}),[2]);case 2:return h=t.sent(),r.h.dispatch((0,s.N5)()),[4,P(h,c,n,y,b)];case 3:return t.sent(),[2]}}))}))})),g.label=3;case 3:return[2]}}))}))}function P(a,e,n,c,i){return(0,t.mG)(this,void 0,void 0,(function(){var u;return(0,t.Jh)(this,(function(t){switch(t.label){case 0:return"Completed"===a.data.statusDetails.state?[3,1]:(r.h.dispatch((0,s.tv)()),[3,8]);case 1:return[4,n.setOrderStatus(i,c,{amazonpay:{session_id:e},paymentStatus:"success",orderStatus:"success"})];case 2:t.sent(),r.h.dispatch((0,m.ud)({provider:"amazonpay",method:"amazonpay"})),t.label=3;case 3:return t.trys.push([3,5,,7]),[4,(0,h.ll)()];case 4:return t.sent(),[3,7];case 5:return u=t.sent(),console.error(u),[4,c.complete({note:"Failed to update customer in browser :: ".concat((0,o.H)(u))})];case 6:return t.sent(),[3,7];case 7:(0,y.c)(),window.top&&(window.top.location=i.redirect),t.label=8;case 8:return[2]}}))}))}}}]);